# 跟牌和甩牌测试方案

## 📋 测试目标

全面测试山东升级游戏中的跟牌规则和甩牌机制，确保：
1. 基础跟牌规则正确实现
2. 强制跟牌规则正确执行
3. 甩牌验证逻辑准确
4. 垫牌规则合理
5. 主杀和超吃机制正常工作

## 🎯 测试范围

### 1. 基础跟牌规则

#### 1.1 单张跟牌
- ✅ 有花色时必须跟花色
- ✅ 有花色时可以出任意同花色单张
- ✅ 没有花色时可以垫牌
- ⚠️ 主副牌识别准确性（常主2,3,5）

#### 1.2 对子跟牌
- ✅ 有对子时必须出对子
- ✅ 没有对子时必须出两张最大的单张
- ⚠️ 对子识别（同花色同点数）
- ⚠️ 王对王的特殊处理

#### 1.3 连对跟牌
- ✅ 有足够连对时可以选择出哪些连对
- ✅ 有部分对子时必须出所有对子+最大单张补全
- ✅ 没有对子时必须出最大的单张
- ⚠️ 连对识别准确性
- ⚠️ 常主不能形成连对

### 2. 特殊牌型跟牌

#### 2.1 闪/震跟牌
- ✅ 有同长度闪/震时可以选择
- ✅ 没有同长度闪/震时必须出最大的单张
- ⚠️ 闪/震识别（4张不同花色主牌）
- ⚠️ 震可以降级使用

#### 2.2 顺子（雨）跟牌
- ✅ 有同长度顺子时可以选择
- ✅ 没有同长度顺子时必须出最大的单张
- ⚠️ 顺子识别（同花色连续5张+）
- ⚠️ 顺子中的对子处理
- ⚠️ 顺子比较规则（长度+对子数+最大牌值）

### 3. 甩牌机制

#### 3.1 甩牌验证（领牌阶段）
- ✅ 检测所有组合单位（单张、对子、连对、闪震、顺子）
- ✅ 判断是否会被其他玩家否定
- ✅ 被否定时强制出最小单位
- ⚠️ 单位提取准确性
- ⚠️ 否定判断逻辑
- ⚠️ 最小单位查找

#### 3.2 甩牌跟牌
- ✅ 分析甩牌组成
- ✅ 构建强制跟牌组合
- ✅ 验证跟牌是否符合要求
- ⚠️ 复杂甩牌组合处理
- ⚠️ 跟牌组合匹配

### 4. 垫牌规则

#### 4.1 花色不够时垫牌
- ✅ 该花色牌数 < 出牌数量时允许混合花色
- ✅ 完全没有该花色时可以出任意牌
- ⚠️ 垫牌时的牌型限制

#### 4.2 主杀
- ✅ 没有副牌时可以用主牌杀
- ⚠️ 主杀牌型必须匹配（暂时已放宽）
- ⚠️ 超吃规则

### 5. 主副牌识别

#### 5.1 主牌识别
- ✅ 大小王
- ✅ 级牌（所有花色的级牌）
- ✅ 常主（2, 3, 5）
- ✅ 主花色的牌
- ⚠️ 级牌是常主时的处理（如打2，则2不是常主）

#### 5.2 副牌识别
- ✅ 非主花色的非常主非级牌
- ⚠️ 边界情况处理

## 🐛 已知问题和重点检查区域

### 高优先级

1. **常主在副牌花色的识别**
   - 问题：领出红桃时，红桃3和红桃5是主牌，不能作为红桃副牌跟牌
   - 测试：`testTrumpFollowSuit()`
   - 状态：需要验证

2. **对子识别的准确性**
   - 问题：检查是否正确识别同花色同点数的对子
   - 测试：`testPairFollow()`
   - 状态：需要验证

3. **连对不能由常主形成**
   - 问题：常主2,3,5不能形成连对
   - 相关：`getSequentialValue` 为常主分配非连续数值
   - 状态：需要验证

4. **甩牌否定逻辑**
   - 问题：是否正确检测所有玩家的否定能力
   - 涉及：单位提取、否定判断、最小单位查找
   - 测试：`testMixedCardValidation()`
   - 状态：需要深度测试

### 中优先级

5. **甩牌跟牌规则**
   - 问题：跟甩牌时的组合匹配是否准确
   - 测试：`testMixedFollow()`
   - 状态：需要测试复杂场景

6. **垫牌时的主杀匹配**
   - 问题：当前已放宽限制，是否影响游戏公平性
   - 位置：`validateCardTypeMatch()` line 1471-1474
   - 状态：需要讨论

7. **顺子中的对子处理**
   - 问题：雨（顺子）可以包含对子，比较时对子数要相同
   - 状态：需要验证

### 低优先级

8. **性能优化**
   - 问题：甩牌验证涉及大量计算，是否有性能问题
   - 状态：待性能测试

9. **边界情况**
   - 问题：空手牌、超大手牌等极端情况
   - 状态：需要补充测试

## 📊 测试用例设计

### 测试用例1: 单张跟牌
```
场景：玩家0出红桃A，玩家1有红桃K和梅花Q
预期：
- 出红桃K → 通过
- 出梅花Q → 失败（有红桃必须跟）
```

### 测试用例2: 对子强制规则
```
场景：玩家0出对A，玩家1有对K和单7,8
预期：
- 出对K → 通过（有对子必须出对子）
- 出单7+单8 → 失败（有对子必须出对子）

场景：玩家0出对A，玩家1只有单K,7,6
预期：
- 出单K+单7 → 通过（没有对子，出两张最大）
- 出单7+单6 → 失败（必须出最大的两张）
```

### 测试用例3: 主副牌识别
```
级别：2，主花色：黑桃
测试：
- 大王 → 主牌 ✓
- 小王 → 主牌 ✓
- 黑桃2 → 主牌 ✓（主级牌）
- 红桃2 → 主牌 ✓（副级牌）
- 红桃3 → 主牌 ✓（常主）
- 红桃5 → 主牌 ✓（常主）
- 黑桃K → 主牌 ✓（主花色）
- 红桃K → 副牌 ✓
```

### 测试用例4: 常主不能跟副牌
```
场景：玩家0出红桃A（副牌），玩家1有红桃K,红桃3,黑桃A
预期：
- 出红桃K → 通过（红桃副牌）
- 出红桃3 → 失败（红桃3是常主，属于主牌）
- 出黑桃A → 失败（有红桃副牌必须跟）
```

### 测试用例5: 垫牌规则
```
场景：玩家0出对A，玩家1只有1张红桃7
预期：
- 出红桃7+任意牌 → 通过（牌数不够，允许垫牌）
```

### 测试用例6: 连对跟牌
```
场景：玩家0出KKQQ连对，玩家1有JJ,1010
预期：
- 出JJ,1010 → 通过（有连对）

场景：玩家0出KKQQ连对，玩家1只有JJ,9,8
预期：
- 出JJ,9,8 → 通过（有1对，补2张最大单张）

场景：玩家0出KKQQ连对，玩家1只有A,K,J,9
预期：
- 出A,K,J,9 → 通过（没有对子，出4张最大）
```

### 测试用例7: 甩牌成功
```
场景：玩家0甩A,K,Q，其他玩家都没有更大的红桃单张
预期：
- 甩牌成功 → 通过
```

### 测试用例8: 甩牌被否定
```
场景：玩家0甩K,Q,J，玩家2有红桃A
预期：
- 甩牌被否定，强制出J → 通过
```

### 测试用例9: 甩牌跟牌
```
场景：玩家0甩对A+单K，玩家1有对Q+单J
预期：
- 出对Q+单J → 通过（对+单匹配）
```

## 🔧 测试执行

### 自动化测试

```bash
# 运行测试脚本
cd backend
node src/models/FollowCardTest.js
```

### 手动测试清单

- [ ] 基础单张跟牌
- [ ] 对子强制规则
- [ ] 主副牌识别
- [ ] 常主识别
- [ ] 垫牌规则
- [ ] 主杀规则
- [ ] 连对跟牌
- [ ] 闪/震跟牌
- [ ] 顺子跟牌
- [ ] 甩牌验证
- [ ] 甩牌跟牌
- [ ] 边界情况

### 集成测试

在真实游戏环境中测试：

1. 创建4人游戏房间
2. 发牌后测试各种跟牌场景
3. 记录异常情况
4. 验证前后端逻辑一致性

## 📝 测试记录模板

```
测试日期: ____________________
测试人员: ____________________
测试环境: ____________________

测试结果:
┌─────────────────────────────────────────────────┐
│ 测试项                    │ 状态 │ 备注         │
├─────────────────────────────────────────────────┤
│ 1. 单张跟牌               │      │              │
│ 2. 对子跟牌               │      │              │
│ 3. 主副牌识别             │      │              │
│ 4. 垫牌规则               │      │              │
│ 5. 连对跟牌               │      │              │
│ 6. 甩牌验证               │      │              │
│ 7. 甩牌跟牌               │      │              │
└─────────────────────────────────────────────────┘

发现的问题:
1. __________________________________________________
2. __________________________________________________
3. __________________________________________________

建议:
__________________________________________________
__________________________________________________
```

## 🚀 后续改进

### 短期目标
1. 修复所有已知bug
2. 补充边界情况测试
3. 完善错误提示信息

### 中期目标
1. 添加性能测试
2. 优化甩牌验证算法
3. 增强前端验证逻辑

### 长期目标
1. 建立自动化测试CI/CD
2. 添加回归测试
3. 建立测试覆盖率监控

## 📚 参考资料

- [山东升级游戏规则](./GAME_RULES.md)
- [跟牌规则技术实现](./FOLLOW_CARD_IMPLEMENTATION.md)
- [测试结果报告](./FOLLOW_CARD_TEST_RESULTS.md)

---

**创建日期**: 2024年10月14日  
**最后更新**: 2024年10月14日  
**版本**: 1.0.0

